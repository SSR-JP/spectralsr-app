(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[3797],{6102:function(e,t,r){Promise.resolve().then(r.bind(r,2602))},2602:function(e,t,r){"use strict";r.r(t),r.d(t,{default:function(){return P}});var n=r(9241),o=r(4299),a=r(3460),s=r(3098),c=r(8153),i=r(9337),l=r(137),u=r(4593),d=r(2305),f=r(270),h=r(4696),p=r(335),g=r(468),m=r(511),v=r(6548);function y(e){let{onCancel:t}=e,[r]=(0,a.fl)(),o=(0,c.PQ)(c.YI.primary.getArgb(r.scheme));(0,c.PQ)(c.YI.surface.getArgb(r.scheme));let y=(0,c.PQ)(c.YI.surfaceContainer.getArgb(r.scheme));return(0,n.tZ)(u.Z,{open:!0,css:(0,s.iv)({zIndex:9999,backgroundColor:(0,d.Fq)("#000",.7),backdropFilter:"blur(4px)"}),children:(0,n.tZ)(f.Z,{css:(0,s.iv)({backgroundColor:y,maxWidth:"400px",width:"90%",margin:"0 16px"}),children:(0,n.BX)(h.Z,{css:(0,s.iv)({display:"flex",flexDirection:"column",alignItems:"center",padding:"32px",textAlign:"center",position:"relative"}),children:[(0,n.tZ)(p.Z,{onClick:t,css:(0,s.iv)({position:"absolute",top:"8px",right:"8px"}),children:(0,n.tZ)(i.Z,{})}),(0,n.tZ)(l.Z,{css:(0,s.iv)({fontSize:"48px",color:o,marginBottom:"16px"})}),(0,n.tZ)(g.Z,{css:(0,s.iv)({color:o,marginBottom:"16px"})}),(0,n.tZ)(m.Z,{variant:"h6",css:(0,s.iv)({marginBottom:"8px"}),children:"決済処理中..."}),(0,n.tZ)(m.Z,{variant:"body1",css:(0,s.iv)({marginBottom:"16px"}),children:"新しいタブで決済を続行してください"}),(0,n.tZ)(m.Z,{variant:"body2",color:"textSecondary",css:(0,s.iv)({marginBottom:"24px"}),children:"決済が完了すると自動的にこの画面は閉じられます"}),(0,n.tZ)(v.Z,{variant:"outlined",onClick:t,css:(0,s.iv)({borderColor:o,color:o}),children:"キャンセル"})]})})})}var x=r(1527),Z=r(1638),S=r(1733),b=r(9806),k=r(6463),C=r(5041),w=r(2265);function P(){let[e]=(0,a.fl)(),t=(0,c.PQ)(c.YI.primary.getArgb(e.scheme)),r=(0,c.PQ)(c.YI.surface.getArgb(e.scheme));(0,c.PQ)(c.YI.surfaceContainer.getArgb(e.scheme)),(0,c.PQ)(c.YI.onSurface.getArgb(e.scheme)),(0,c.PQ)(c.YI.onSurfaceVariant.getArgb(e.scheme));let i=(0,k.useRouter)(),[l,u]=(0,w.useState)("---"),[f]=(0,o.mN)(),[h,g]=(0,w.useState)(!1),[P,I]=(0,w.useState)(!1),A=(0,w.useRef)(null),B=(0,w.useRef)(null),T=async()=>{let e=f.apiGatewayUrl,t=f.apiClient.getAccessToken();try{let r=await fetch("".concat(e,"/tickets/balance"),{headers:{Authorization:"Bearer ".concat(t)}});if(!r.ok)throw Error("HTTP error! status: ".concat(r.status));let n=await r.json();u(n.ticket_balance.toFixed(0))}catch(e){console.error("Failed to fetch ticket count:",e),(0,C.yv)("チケットの取得に失敗しました。",{variant:"error"})}};(0,w.useEffect)(()=>{"connected"===f.serviceStatus&&T()},[f.serviceStatus]),(0,w.useEffect)(()=>("BroadcastChannel"in window&&(B.current=new BroadcastChannel("payment-status"),B.current.onmessage=e=>{if(console.log("Payment message received:",e.data),"PAYMENT_COMPLETE"===e.data.type){if(I(!1),g(!1),"success"===e.data.status){var t;(null===(t=e.data.data)||void 0===t?void 0:t.ticketBalance)!==void 0&&u(e.data.data.ticketBalance.toString()),(0,C.yv)("チケットの購入が完了しました！",{variant:"success"}),T()}else"cancel"===e.data.status?(0,C.yv)("支払いがキャンセルされました。",{variant:"info"}):"error"===e.data.status&&(0,C.yv)("支払いの処理中にエラーが発生しました。",{variant:"error"})}}),()=>{B.current&&B.current.close()}),[]),(0,w.useEffect)(()=>{if(!P||!A.current)return;let e=setInterval(()=>{var t;(null===(t=A.current)||void 0===t?void 0:t.closed)&&(clearInterval(e),I(!1),g(!1),console.log("Payment tab was closed by user"))},1e3);return()=>clearInterval(e)},[P]);let E=async()=>{g(!0);let e=f.apiGatewayUrl,t=f.apiClient.getAccessToken(),r=window.location.origin;try{let n=await fetch("".concat(e,"/payments/checkout-session"),{method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer ".concat(t)},body:JSON.stringify({success_url:"".concat(r,"/payment-success?session_id={CHECKOUT_SESSION_ID}"),cancel_url:"".concat(r,"/payment-cancel"),ticketQuantity:1})});if(!n.ok)throw Error("HTTP error! status: ".concat(n.status));let o=await n.json();console.log("Checkout Session created:",o);let{checkout_url:a}=o;if(A.current=window.open(a,"_blank"),!A.current)throw Error("新しいタブを開けませんでした。ポップアップブロックを無効にしてください。");I(!0)}catch(e){console.error("Purchase failed:",e),(0,C.yv)(e instanceof Error&&e.message.includes("タブ")?e.message:"購入に失敗しました。もう一度お試しください。",{variant:"error"}),g(!1)}};return(0,n.BX)("div",{css:(0,s.iv)({}),children:[(0,n.tZ)(S.Z,{position:"fixed",elevation:0,css:(0,s.iv)({backgroundColor:(0,d.Fq)(r,.5),backdropFilter:"blur(16px)",color:t}),children:(0,n.BX)(b.Z,{children:[(0,n.tZ)(p.Z,{size:"large",edge:"start",color:"inherit",onClick:()=>{i.back()},children:(0,n.tZ)(x.Z,{})}),(0,n.tZ)(m.Z,{variant:"h6",css:(0,s.iv)({fontWeight:"bold"}),children:"ユーザ情報"})]})}),(0,n.tZ)("div",{css:(0,s.iv)({display:"flex",flexDirection:"column",marginTop:"80px",paddingLeft:"16px",paddingRight:"16px",marginLeft:"auto",marginRight:"auto",maxWidth:"1040px"}),children:(0,n.BX)(n.HY,{children:[(0,n.tZ)(m.Z,{variant:"h6",css:(0,s.iv)({fontWeight:"bold"}),children:"チケット"}),(0,n.BX)("div",{css:(0,s.iv)({display:"flex",flexDirection:"column",alignSelf:"center",width:"100%",maxWidth:"288px"}),children:[(0,n.BX)("div",{css:(0,s.iv)({alignItems:"center",alignSelf:"center",padding:"8px",display:"flex",flexDirection:"row"}),children:[(0,n.tZ)(Z.Z,{}),(0,n.tZ)("span",{css:(0,s.iv)({}),children:"残り"}),(0,n.BX)("span",{css:(0,s.iv)({paddingLeft:"8px",fontSize:"24px"}),children:[l,"枚"]})]}),(0,n.tZ)(v.Z,{css:(0,s.iv)({}),variant:"contained",onClick:E,disabled:h||P,children:P?"決済処理中...":h?"処理中...":"購入"})]})]})}),P&&(0,n.tZ)(y,{onCancel:()=>{A.current&&!A.current.closed&&A.current.close(),I(!1),g(!1)}})]})}},4299:function(e,t,r){"use strict";r.d(t,{Er:function(){return m},NZ:function(){return u},ZP:function(){return a},mN:function(){return p},xh:function(){return s}});var n=r(9241),o=r(2265);let a="ap-northeast-3_MHzKaeUD4",s="6sdbfpo82ihpb97v8kgo7d8jr8",c="https://dnoqck0cue.execute-api.ap-northeast-3.amazonaws.com/prod",i="".concat(c,"/services/current"),l={"ssr.broken-database":"データベースが破損しています。","ssr.incompatible-extension":"データに互換性のない拡張子が含まれています。","ssr.extension-unmatched":"拡張子が一致しません。","ssr.load-failure":"データの読み込みに失敗しました。","ssr.incompatible-npl":"データのNPLスタイルが互換性がありません。","ssr.file-info-unmatched":"ファイル間でNPL情報が統一されていません。","ssr.data-info-unmatched":"データ間でNPL情報が統一されていません。","ssr.data-size-unmatched":"データ間でサイズが統一されていません。","ssr.incorrect-parameters":"パラメータの指定が正しくありません。","ssr.get-mean-failure":"平均値の取得に失敗しました。","ssr.fitting-failure":"フィッティングに失敗しました。","ssr.wrong-fitting-result":"フィッティング結果が妥当ではありません。","ssr.out-of-memory":"メモリ不足です。","ssr.grid-contains-outside":"予想される位置が範囲外に含まれています。","ssr.others":"不明なエラーが発生しました。","ticket.consume-failed":"計算チケットが不足しています。"};async function u(e){if(e.ok)return;if(404===e.status)return"通信先が見つかりませんでした(404)。";let t=await e.text();try{let e=JSON.parse(t);console.log(e);let r=function(e){if(void 0==e)return;let t=e.detail;if(void 0==t)return;let r=t.code,n=t.message;if(void 0!=r&&void 0!=n&&"string"==typeof r&&"string"==typeof n)return l[r]||n}(e);if(void 0!=r)return r}catch(e){console.warn("Failed to parse error response",e)}return"エラーが発生しました。".concat(e.status,": ").concat(t)}let d=(0,o.createContext)({apiClient:g(c,i,null),apiGatewayUrl:c,serviceStatus:"configuring"}),f=(0,o.createContext)(()=>{}),h=(e,t)=>"setServiceStatus"===t.type?{...e,serviceStatus:t.payload.status}:e,p=()=>{let e=(0,o.useContext)(d),t=(0,o.useContext)(f);return(0,o.useRef)(e).current=e,[e,(0,o.useMemo)(()=>({setServiceStatus:e=>{t({type:"setServiceStatus",payload:{status:e}})}}),[])]};function g(e,t,r){let n=async(e,n,o)=>{let a=n.length>0?"?"+n.join("&"):"",s="".concat(t,"/").concat(e).concat(a),c=new Headers(null==o?void 0:o.headers);return r&&c.set("Authorization","Bearer ".concat(r)),fetch(s,{...o,headers:c})};return console.log("makeApiClient()"),{serviceFetch:async(e,t,r)=>n(e,t,r),setNewAccessToken:e=>{r=e,localStorage.setItem("token",e)},getAccessToken:()=>r,restoreServiceSession:async()=>{r=localStorage.getItem("token");try{let e=await n("hello",[]);if(!e.ok)throw Error("HTTP error! status: ".concat(e.status))}catch(e){return console.error(e),!1}return!0}}}function m(e){let{children:t}=e,r=(0,o.useMemo)(()=>g(c,i,null),[]),[a,s]=(0,o.useReducer)(h,{apiClient:r,apiGatewayUrl:c,serviceStatus:"configuring"}),l=(0,o.useRef)(!1);return(0,o.useEffect)(()=>{if(!l.current)return async function(){try{let e=await a.apiClient.restoreServiceSession();console.log("restoreServiceSession",e),e?s({type:"setServiceStatus",payload:{status:"connected"}}):s({type:"setServiceStatus",payload:{status:"not-login"}})}catch(e){console.error(e),s({type:"setServiceStatus",payload:{status:"not-login"}})}}(),()=>{l.current=!0}},[]),(0,n.tZ)(d.Provider,{value:a,children:(0,n.tZ)(f.Provider,{value:s,children:t})})}},3460:function(e,t,r){"use strict";r.d(t,{ThemeStoreProvider:function(){return m},fl:function(){return p}});var n=r(9241),o=r(8438),a=r.n(o),s=r(9380),c=r(2686),i=r(1705),l=r(8153),u=r(2265),d=r(1246);let f=(0,u.createContext)({scheme:new l.S2(l.OP.fromInt(4435848),!1,-1),sourceColor:4435848}),h=(0,u.createContext)(()=>{}),p=()=>{let e=(0,u.useContext)(f),t=(0,u.useContext)(h);return[e,{resetSourceColor:()=>{t({type:"setTheme",payload:{scheme:new l.S2(l.OP.fromInt(4435848),!1,-1),sourceColor:4435848}})}}]},g=(e,t)=>{if("setTheme"===t.type){let{scheme:r,sourceColor:n}=t.payload;return e.sourceColor===n?e:{...e,scheme:r,sourceColor:n}}return e},m=e=>{let{children:t}=e,[r,o]=(0,u.useReducer)(g,{scheme:new l.S2(l.OP.fromInt(4435848),!1,-1),sourceColor:4435848}),p=(0,s.Z)((0,c.Z)({palette:{mode:"light",primary:{main:(0,l.PQ)(l.YI.primary.getArgb(r.scheme))},secondary:{main:(0,l.PQ)(l.YI.secondary.getArgb(r.scheme))},background:{default:(0,l.PQ)(l.YI.surface.getArgb(r.scheme)),paper:(0,l.PQ)(l.YI.surfaceContainer.getArgb(r.scheme))},error:{main:(0,l.PQ)(l.YI.error.getArgb(r.scheme))},text:{primary:(0,l.PQ)(l.YI.onSurface.getArgb(r.scheme))}},typography:{fontFamily:a().style.fontFamily}}));return(0,n.BX)(i.Z,{theme:p,children:[(0,n.tZ)(d.Z,{styles:e=>({body:{transition:e.transitions.create(["background-color","transform"])}})}),(0,n.tZ)(f.Provider,{value:r,children:(0,n.tZ)(h.Provider,{value:o,children:t})})]})}}},function(e){e.O(0,[1665,9241,526,2036,1650,3676,5981,933,8596,2971,7023,1744],function(){return e(e.s=6102)}),_N_E=e.O()}]);